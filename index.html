<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plant & Tool Checkout</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; text-align: center; background: #f0f2f5; color: #1c1e21; }
        .container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.1); max-width: 400px; margin: auto; }
        h2 { color: #0078d4; margin-bottom: 5px; }
        p { color: #606770; margin-bottom: 20px; font-size: 14px; }
        .asset-box { background: #e7f3ff; color: #0078d4; padding: 12px; border-radius: 8px; font-weight: bold; margin-bottom: 20px; border: 1px solid #bbdefb; }
        input, select, button { width: 100%; padding: 14px; margin: 10px 0; font-size: 16px; border-radius: 8px; border: 1px solid #ccd0d5; box-sizing: border-box; outline: none; }
        input:focus, select:focus { border-color: #0078d4; box-shadow: 0 0 0 2px rgba(0,120,212,0.2); }
        button { background: #0078d4; color: white; border: none; font-weight: bold; cursor: pointer; transition: background 0.2s; margin-top: 20px; }
        button:active { background: #005a9e; transform: scale(0.98); }
        
        .btn-secondary { background: #f0f2f5; color: #1c1e21; border: 1px solid #ccd0d5; margin-top: 5px; margin-bottom: 15px; }
        .btn-working { background: #28a745; margin-top: 10px; }
        .btn-faulty { background: #dc3545; margin-top: 10px; }
        .btn-reset { background: #6c757d; font-size: 12px; padding: 8px; margin-top: 30px; opacity: 0.7; }
        
        #status { margin-top: 15px; font-weight: bold; font-size: 14px; min-height: 20px; }
        .hidden { display: none; }
        a { color: #0078d4; text-decoration: none; font-weight: bold; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <h2>üèóÔ∏è Renelec Plant</h2>
        <p>Enter name & select site</p>
        <p>If your site is missing from the list, press 'My Site is Not Listed' and type missing site name. This will send a notification for the site to be added</p>
        
        <div id="assetDisplay" class="asset-box">Identifying Equipment...</div>

        <div id="restOfForm">
            <input type="text" id="workerName" placeholder="Enter Your Name">

            <select id="jobSite" onchange="handleSiteSelection()">
                <option value="" disabled selected>Loading Active Contracts...</option>
            </select>

            <button type="button" id="notListedBtn" class="btn-secondary" onclick="showMissingSiteBox()">My site is not listed</button>

            <div id="conditionSection" class="hidden">
                <p style="margin-bottom: 5px; font-weight: bold;">Condition of Equipment:</p>
                <button type="button" class="btn-working" onclick="setCondition('Working')">‚úÖ Working</button>
                <button type="button" class="btn-faulty" onclick="setCondition('Faulty')">‚ùå Faulty</button>
            </div>

            <div id="faultSection" class="hidden">
                <input type="text" id="faultDesc" placeholder="Describe the fault...">
            </div>

            <button id="submitBtn" class="hidden" onclick="submitScan()">Confirm Checkout</button>
        </div>

        <div id="missingSiteSection" class="hidden" style="background-color: #ffeaea; padding: 15px; border-radius: 8px; border-left: 4px solid red; margin-top: 15px; text-align: left;">
            <h4 style="margin-top: 0; color: #d32f2f;">Request a New Site</h4>
            <input type="text" id="newSiteName" placeholder="Type missing site name...">
            <button type="button" style="background: #d32f2f;" onclick="sendAlert()">Send Alert & Wait</button>
            <button type="button" class="btn-secondary" onclick="resetForm()">Back</button>
        </div>

        <div id="status"></div>
        
        <button type="button" class="btn-reset" onclick="resetForm()">Reset Form</button>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const assetId = urlParams.get('asset') || "Unknown Asset";
        document.getElementById('assetDisplay').innerText = "Asset ID: " + assetId;

        let selectedCondition = "";

        // FETCH SITES
        fetch('https://raw.githubusercontent.com/NWRenGW/Plant-Tracker/refs/heads/main/sites.json') 
            .then(res => res.json())
            .then(data => {
                let dropdown = document.getElementById('jobSite');
                dropdown.innerHTML = '<option value="" disabled selected>Where is it going?</option>';
                data.forEach(item => {
                    let opt = document.createElement('option');
                    opt.value = item.SiteName; 
                    opt.innerText = item.SiteName;
                    dropdown.appendChild(opt);
                });
            });

        function handleSiteSelection() {
            document.getElementById('notListedBtn').classList.add('hidden');
            document.getElementById('conditionSection').classList.remove('hidden');
        }

        function setCondition(status) {
            selectedCondition = status;
            const faultBox = document.getElementById('faultSection');
            const submitBtn = document.getElementById('submitBtn');

            if (status === 'Faulty') {
                faultBox.classList.remove('hidden');
            } else {
                faultBox.classList.add('hidden');
                document.getElementById('faultDesc').value = ""; 
            }
            submitBtn.classList.remove('hidden');
            document.getElementById('status').innerText = "Selected: " + status;
        }

        function resetForm() {
            location.reload(); 
        }

        function showMissingSiteBox() {
            document.getElementById("restOfForm").style.display = "none";
            document.getElementById("missingSiteSection").classList.remove('hidden');
        }

        // ADDED BACK: Missing Site Alert Function
        function sendAlert() {
            let newSite = document.getElementById("newSiteName").value;
            let alertBox = document.getElementById("missingSiteSection");
            
            if (newSite.trim() === "") {
                alert("Please type a site name first!");
                return;
            }

            alertBox.innerHTML = "<h4 style='margin-top: 0; color: #d32f2f;'>Request a New Site</h4><p style='color: #d32f2f; font-weight: bold;'>‚è≥ Sending alert...</p>";

            const alertFlowUrl = 'https://default267b2c46e98b42ef93ce19c08b7664.4d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/3f5a928b87b34145bae782d083e060bc/triggers/manual/paths/invoke?api-version=1';

            fetch(alertFlowUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    assetId: assetId,
                    newSite: newSite
                })
            }).then(response => {
                if (response.ok) {
                    alertBox.innerHTML = "<h4 style='color: green; margin-top:0;'>‚úÖ Alert Sent!</h4><p style='font-size: 13px;'>The team has been notified. Please wait until the site is added, then refresh this page to scan again.</p>";
                } else {
                    throw new Error();
                }
            }).catch(() => {
                // UPDATED: Failsafe contact message with clickable emails
                alertBox.innerHTML = "<h4 style='color: red; margin-top:0;'>‚ùå Error Sending Alert</h4><p style='font-size: 13px; color: #1c1e21;'>The system failed to send the alert automatically.</p><p style='font-size: 13px; color: #1c1e21;'>Please contact <a href='mailto:nathan.wild@renelec.com'>nathan.wild@renelec.com</a> or <a href='mailto:stephen.waite@renelec.com'>stephen.waite@renelec.com</a> directly to have the site added.</p>";
            });
        }

        // MAIN CHECKOUT FUNCTION
        function submitScan() {
            const worker = document.getElementById('workerName').value.trim();
            const site = document.getElementById('jobSite').value;
            const fault = document.getElementById('faultDesc').value;
            const statusText = document.getElementById('status');
            const btn = document.getElementById('submitBtn');

            if (!worker || !site) { alert("Please enter name and site."); return; }

            statusText.innerText = "‚è≥ Saving...";
            btn.disabled = true;

            navigator.geolocation.getCurrentPosition((pos) => {
                const flowUrl = 'https://default267b2c46e98b42ef93ce19c08b7664.4d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/1812e0c80428404aa87f0392a5ac73ef/triggers/manual/paths/invoke?api-version=1';

                fetch(flowUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        assetId: assetId,
                        workerName: worker,
                        jobSite: site,
                        condition: selectedCondition,
                        faultDescription: fault,
                        lat: pos.coords.latitude.toString(),
                        lon: pos.coords.longitude.toString()
                    })
                }).then(response => {
                    if (response.ok) {
                        statusText.innerText = "‚úÖ Success! Asset Logged.";
                        statusText.style.color = "green";
                    }
                }).catch(() => {
                    statusText.innerText = "‚ùå Error: Could not save.";
                }).finally(() => { btn.disabled = false; });
            }, (error) => {
                alert("GPS required.");
                btn.disabled = false;
            });
        }
    </script>
</body>
</html>
