<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plant & Tool Checkout</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; text-align: center; background: #f0f2f5; color: #1c1e21; }
        .container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.1); max-width: 400px; margin: auto; }
        h2 { color: #0078d4; margin-bottom: 5px; }
        p { color: #606770; margin-bottom: 20px; font-size: 14px; }
        .asset-box { background: #e7f3ff; color: #0078d4; padding: 12px; border-radius: 8px; font-weight: bold; margin-bottom: 20px; border: 1px solid #bbdefb; }
        input, select, button { width: 100%; padding: 14px; margin: 10px 0; font-size: 16px; border-radius: 8px; border: 1px solid #ccd0d5; box-sizing: border-box; outline: none; }
        input:focus, select:focus { border-color: #0078d4; box-shadow: 0 0 0 2px rgba(0,120,212,0.2); }
        button { background: #0078d4; color: white; border: none; font-weight: bold; cursor: pointer; transition: background 0.2s; margin-top: 20px; }
        button:active { background: #005a9e; transform: scale(0.98); }
        #status { margin-top: 15px; font-weight: bold; font-size: 14px; min-height: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h2>üèóÔ∏è Renelec Plant</h2>
        <p>Issues to: nathan.wild@renelec.com</p>
        <p>Enter name & Select site from dropdown</p>
        
        <div id="assetDisplay" class="asset-box">Identifying Equipment...</div>

        <input type="text" id="workerName" placeholder="Enter Your Name" autocomplete="name">

        <select id="jobSite">
            <option value="" disabled selected>Loading Active Contracts...</option>
        </select>

        <button id="submitBtn" onclick="submitScan()">Confirm Checkout</button>
        <div id="status"></div>
    </div>

    <script>
        // 1. GET ASSET ID FROM THE QR CODE URL (?asset=EXC-01)
        const urlParams = new URLSearchParams(window.location.search);
        const assetId = urlParams.get('asset') || "Unknown Asset";
        document.getElementById('assetDisplay').innerText = "Asset ID: " + assetId;

        // 2. FETCH LIVE CONTRACTS LIST
        // Replace this URL with your actual GitHub link to your sites.json
        const jsonUrl = 'https://raw.githubusercontent.com/NWRenGW/Plant-Tracker/refs/heads/main/sites.json';

        fetch(jsonUrl) 
            .then(res => res.json())
            .then(data => {
                let dropdown = document.getElementById('jobSite');
                dropdown.innerHTML = '<option value="" disabled selected>Where is it going?</option>';
                data.forEach(item => {
                    let opt = document.createElement('option');
                    // 'SiteName' must match the key used in your Power Automate 'Select' action
                    opt.value = item.SiteName; 
                    opt.innerText = item.SiteName;
                    dropdown.appendChild(opt);
                });
            })
            .catch(err => {
                console.error("Fetch error:", err);
                document.getElementById('jobSite').innerHTML = '<option>Error loading sites</option>';
            });

        function submitScan() {
            const worker = document.getElementById('workerName').value.trim();
            const site = document.getElementById('jobSite').value;
            const status = document.getElementById('status');
            const btn = document.getElementById('submitBtn');

            if (!worker || !site) { 
                alert("Please enter your name and select a site."); 
                return; 
            }

            status.innerText = "‚è≥ Requesting GPS & saving...";
            status.style.color = "#606770";
            btn.disabled = true;

            navigator.geolocation.getCurrentPosition((pos) => {
                // 3. SEND DATA TO YOUR FLOW 2 "CATCH LINK"
                // Replace this URL with your HTTP POST URL from Flow 2
                const flowUrl = 'https://default267b2c46e98b42ef93ce19c08b7664.4d.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/1812e0c80428404aa87f0392a5ac73ef/triggers/manual/paths/invoke?api-version=1';

                fetch(flowUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        assetId: assetId,
                        workerName: worker,
                        jobSite: site,
                        lat: pos.coords.latitude.toString(),
                        lon: pos.coords.longitude.toString()
                    })
                }).then(response => {
                    if (response.ok) {
                        status.innerText = "‚úÖ Success! Asset Logged.";
                        status.style.color = "green";
                        // Clear name for next scan
                        document.getElementById('workerName').value = "";
                    } else {
                        throw new Error();
                    }
                }).catch(() => {
                    status.innerText = "‚ùå Error: Could not save scan.";
                    status.style.color = "red";
                }).finally(() => {
                    btn.disabled = false;
                });
            }, (error) => {
                alert("Please enable Location/GPS to confirm checkout.");
                status.innerText = "‚ùå GPS permission required.";
                btn.disabled = false;
            }, { enableHighAccuracy: true });
        }
    </script>
</body>

</html>

